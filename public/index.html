
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>What happens here, stays in here.</title>
	<meta name="author" content="sunus">

	
	<meta name="description" content="Hey, Long time no see. i have been on holiday for about a week and we&#8217;ll get back to Tianjin in a few days later. We&#8217;d been to Nanjing, &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="What happens here, stays in here." type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>
	
</head>

<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	<img src="/images/icon.png" alt="Profile Picture" style="width: 160px;">
</div>
<h1><a href="/">What happens here, stays in here.</a></h1>
<p class="subtitle">I am sunus, A quite normal guy happened to know something about programming. Now, I am trying hard to be a guy that deserve you.</p>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/sunuslee" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/sunuslee" title="GitHub">GitHub</a>
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>

</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				

			
			<div class="mid-col-container">
				<div id="content" class="inner"><script src="/javascripts/jquery.bpopup.min.js" type="text/javascript"> </script>
<script src="/javascripts/antiWindows.js" type="text/javascript"> </script>



    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-05-29T23:56:00+08:00" pubdate data-updated="true">May 29<span>th</span>, 2013</time></div>
		<div class="tags">

</div>
		
			<span class="comments"><a href="/blog/2013/05/29/on-holiday/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2013/05/29/on-holiday/">On Holiday</a></h1>
	<div class="entry-content">
		<p>Hey, Long time no see. i have been on holiday for about a week and we&#8217;ll get back to Tianjin in a few days later.</p>

<p>We&#8217;d been to <strong>Nanjing</strong>, <strong>Suzhou</strong> and we just got to the last destination, that&#8217;s, <strong>Hangzhou</strong>.</p>

<p>Overall, the holiday is fun and interesting. but, <strong>I just wish you were here</strong>, to see the beautiful views and having the yummy &amp; delicious local foods.</p>

<p>and also, take some of the stupid and funny pictures like this:</p>

<p><img src="/images/2013-travel-in-may.jpg" title="Fun and Stupid" alt="fun and stupid but wish you were sitting right next to me" /></p>

<p>good night and good luck !</p>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-05-17T09:52:00+08:00" pubdate data-updated="true">May 17<span>th</span>, 2013</time></div>
		<div class="tags">

</div>
		
			<span class="comments"><a href="/blog/2013/05/17/great-article-about-troublshooting-a-server-in-first-five-minutes/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2013/05/17/great-article-about-troublshooting-a-server-in-first-five-minutes/">Great Article About Troublshooting a Server in First Five Minutes</a></h1>
	<div class="entry-content">
		<h2>I didn&#8217;t write this, i found the post a few days ago and i think it can be very helpful, so i make a copy here.</h2>

<h3><a href="http://devo.ps/blog/2013/03/06/troubleshooting-5minutes-on-a-yet-unknown-box.html">Original Link Here</a></h3>

<h1>First 5 Minutes Troubleshooting A Server</h1>

<p>Back when our team was dealing with operations, optimization and scalability at <a href="http://wiredcraft.com">our previous company</a>, we had our fair share of troubleshooting poorly performing applications and infrastructures of various sizes, often large (think CNN or the World Bank). Tight deadlines, “exotic” technical stacks and lack of information usually made for memorable experiences.</p>

<p>The cause of the issues was rarely obvious: here are a few things we usually got started with.</p>

<h3>Get some context</h3>

<p>Don’t rush on the servers just yet, you need to figure out how much is already known about the server and the specifics of the issues. You don’t want to waste your time (trouble) shooting in the dark.</p>

<p>A few “must have”:</p>

<ul>
<li>What exactly are the symptoms of the issue? Unresponsiveness? Errors?</li>
<li>When did the problem start being noticed?</li>
<li>Is it reproducible?</li>
<li>Any pattern (e.g. happens every hour)?</li>
<li>What were the latest changes on the platform (code, servers, stack)?</li>
<li>Does it affect a specific user segment (logged in, logged out, geographically located…)?</li>
<li>Is there any documentation for the architecture (physical and logical)?</li>
<li><strong>Is there a monitoring platform?</strong> Munin, Zabbix, Nagios, <a href="http://newrelic.com/">New Relic</a>… Anything will do.</li>
<li><strong>Any (centralized) logs?</strong>. Loggly, Airbrake, Graylog…</li>
</ul>


<p>The last two ones are the most convenient sources of information, but don’t expect too much: they’re also the ones usually painfully absent. Tough luck, make a note to get this corrected and move on.</p>

<h3>Who’s there?</h3>

<pre><code>$ w
$ last
</code></pre>

<p>Not critical, but you’d rather not be troubleshooting a platform others are playing with. One cook in the kitchen is enough.</p>

<h3>What was previously done?</h3>

<pre><code>$ history
</code></pre>

<p>Always a good thing to look at; combined with the knowledge of who was on the box earlier on. Be responsible by all means, being admin shouldn’t allow you to break ones privacy.</p>

<p>A quick mental note for later, you may want to update the environment variable <code>HISTTIMEFORMAT</code> to keep track of the time those commands were ran. Nothing is more frustrating than investigating an outdated list of commands…</p>

<h3>What is running?</h3>

<pre><code>$ pstree -a
$ ps aux
</code></pre>

<p>While <code>ps aux</code> tends to be pretty verbose, <code>pstree -a</code> gives you a nice condensed view of what is running and who called what.</p>

<h3>Listening services</h3>

<pre><code>$ netstat -ntlp
$ netstat -nulp
$ netstat -nxlp
</code></pre>

<p>I tend to prefer running them separately, mainly because I don’t like looking at all the services at the same time. <code>netstat -nalp</code> will do to though. Even then, I’d ommit the <code>numeric</code> option (IPs are more readable IMHO).</p>

<p>Identify the running services and whether they’re expected to be running or not. Look for the various listening ports. You can always match the PID of the process with the output of <code>ps aux</code>; this can be quite useful especially when you end up with 2 or 3 Java or Erlang processes running concurrently.</p>

<p>We usual prefer to have more or less specialized boxes, with a low number of services running on each one of them. If you see 3 dozens of listening ports you probably should make a mental note of investigating this further and see what can be cleaned up or reorganized.</p>

<h3>CPU and RAM</h3>

<pre><code>$ free -m
$ uptime
$ top
$ htop
</code></pre>

<p>This should answer a few questions:</p>

<ul>
<li>Any free RAM? Is it swapping?</li>
<li>Is there still some CPU left? How many CPU cores are available on the server? Is one of them overloaded?</li>
<li>What is causing the most load on the box? What is the load average?</li>
</ul>


<h3>Hardware</h3>

<pre><code>$ lspci
$ dmidecode
$ ethtool
</code></pre>

<p>There are still a lot of bare-metal servers out there, this should help with;</p>

<ul>
<li>Identifying the RAID card (with BBU?), the CPU, the available memory slots. This may give you some hints on potential issues and/or performance improvements.</li>
<li>Is your NIC properly set? Are you running in half-duplex? In 10MBps? Any TX/RX errors?</li>
</ul>


<h3>IO Performances</h3>

<pre><code>$ iostat -kx 2
$ vmstat 2 10
$ mpstat 2 10
$ dstat --top-io --top-bio
</code></pre>

<p>Very useful commands to analyze the overall performances of your backend;</p>

<ul>
<li>Checking the disk usage: has the box a filesystem/disk with 100% disk usage?</li>
<li>Is the swap currently in use (si/so)?</li>
<li>What is using the CPU: system? User? Stolen (VM)?</li>
<li><code>dstat</code> is my all-time favorite. What is using the IO? Is MySQL sucking up the resources? Is it your PHP processes?</li>
</ul>


<h3>Mount points and filesystems</h3>

<pre><code>$ mount
$ cat /etc/fstab
$ vgs
$ pvs
$ lvs
$ df -h
$ lsof %2BD / /* beware not to kill your box */
</code></pre>

<ul>
<li>How many filesystems are mounted?</li>
<li>Is there a dedicated filesystem for some of the services? (MySQL by any chance..?)</li>
<li>What are the filesystem mount options: noatime? default? Have some filesystem been re-mounted as read-only?</li>
<li>Do you have any disk space left?</li>
<li>Is there any big (deleted) files that haven’t been flushed yet?</li>
<li>Do you have room to extend a partition if disk space is an issue?</li>
</ul>


<h3>Kernel, interrupts and network usage</h3>

<pre><code>$ sysctl -a | grep ...
$ cat /proc/interrupts
$ cat /proc/net/ip_conntrack /* may take some time on busy servers */
$ netstat
$ ss -s
</code></pre>

<ul>
<li>Are your IRQ properly balanced across the CPU? Or is one of the core overloaded because of network interrupts, raid card, …?</li>
<li>How much is swappinness set to? 60 is good enough for workstations, but when it come to servers this is generally a bad idea: you do not want your server to swap… ever. Otherwise your swapping process will be locked while data is read/written to the disk.</li>
<li>Is <code>conntrack_max</code> set to a high enough number to handle your traffic?</li>
<li>How long do you maintain TCP connections in the various states (<code>TIME_WAIT</code>, …)?</li>
<li><code>netstat</code> can be a bit slow to display all the existing connections, you may want to use <code>ss</code> instead to get a summary.</li>
</ul>


<p>Have a look at <a href="http://www.lognormal.com/blog/2012/09/27/linux-tcpip-tuning/">Linux TCP tuning</a> for some more pointer as to how to tune your network stack.</p>

<h3>System logs and kernel messages</h3>

<pre><code>$ dmesg
$ less /var/log/messages
$ less /var/log/secure
$ less /var/log/auth
</code></pre>

<ul>
<li>Look for any error or warning messages; is it spitting issues about the number of connections in your conntrack being too high?</li>
<li>Do you see any hardware error, or filesystem error?</li>
<li>Can you correlate the time from those events with the information provided beforehand?</li>
</ul>


<h3>Cronjobs</h3>

<pre><code>$ ls /etc/cron* %2B cat
$ for user in $(cat /etc/passwd | cut -f1 -d:); do crontab -l -u $user; done
</code></pre>

<ul>
<li>Is there any cron job that is running too often?</li>
<li>Is there some user’s cron that is “hidden” to the common eyes?</li>
<li>Was there a backup of some sort running at the time of the issue?</li>
</ul>


<h3>Application logs</h3>

<p>There is a lot to analyze here, but it’s unlikely you’ll have time to be exhaustive at first. Focus on the obvious ones, for example in the case of a LAMP stack:</p>

<ul>
<li><strong>Apache &amp; Nginx</strong>; chase down access and error logs, look for <code>5xx</code> errors, look for possible <code>limit_zone</code> errors.</li>
<li><strong>MySQL</strong>; look for errors in the <code>mysql.log</code>, trace of corrupted tables, innodb repair process in progress. Looks for slow logs and define if there is disk/index/query issues.</li>
<li><strong>PHP-FPM</strong>; if you have php-slow logs on, dig in and try to find errors (php, mysql, memcache, …). If not, set it on.</li>
<li><strong>Varnish</strong>; in <code>varnishlog</code> and <code>varnishstat</code>, check your hit/miss ratio. Are you missing some rules in your config that let end-users hit your backend instead?</li>
<li><strong>HA-Proxy</strong>; what is your backend status? Are your health-checks successful? Do you hit your max queue size on the frontend or your backends?</li>
</ul>


<h3>Conclusion</h3>

<p>After these first 5 minutes (give or take 10 minutes) you should have a better understanding of:</p>

<ul>
<li>What is running.</li>
<li>Whether the issue seems to be related to IO/hardware/networking or configuration (bad code, kernel tuning, …).</li>
<li>Whether there’s a pattern you recognize: for example a bad use of the DB indexes, or too many apache workers.</li>
</ul>


<p>You may even have found the actual root cause. If not, you should be in a good place to start digging further, with the knowledge that you’ve covered the obvious.</p>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-05-15T22:35:00+08:00" pubdate data-updated="true">May 15<span>th</span>, 2013</time></div>
		<div class="tags">

</div>
		
			<span class="comments"><a href="/blog/2013/05/15/port-mapping-slash-forwarding-with-iptables-in-linux/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2013/05/15/port-mapping-slash-forwarding-with-iptables-in-linux/">Port Mapping/forwarding With IPTABLES in Linux</a></h1>
	<div class="entry-content">
		<h1>Introduction</h1>

<p>We got a problem with the networking in my dorm and laboratory, if outgoing traffic port is 3389, the connection will be banned. so, we need to figure a way out to connect a Windows server&#8217;s 3389 port, which is suck, i mean, Windows sucks.</p>

<h1>Solution</h1>

<p>I connected to one of the linux server which is in the same lan with Suck Windows Server with port, let&#8217;s say 63389. the the linux with redirect the connection from 63389 to Suck Windows Server&#8217;s port 3389.</p>

<p>this is what i did in the linux server:</p>

<pre><code>    iptables -t nat -I PREROUTING 1 -p tcp -i eth0 --dport 63389 -j DNAT --to-destination SUCK-WIN-IP:3389
    iptables -t nat -A POSTROUTING -p tcp --dport 3389 -j MASQUERADE
</code></pre>

<h2>Note</h2>

<p>the second target <strong> MASQUERADE </strong> is a really handy thing, it will be acting like SNAT most times, but it can also auto-adjust some connection problems with extra <strong>COST</strong></p>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-05-11T23:20:00+08:00" pubdate data-updated="true">May 11<span>th</span>, 2013</time></div>
		<div class="tags">

</div>
		
			<span class="comments"><a href="/blog/2013/05/11/moving-on/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2013/05/11/moving-on/">Moving On</a></h1>
	<div class="entry-content">
		<h1>Summary for the past</h1>

<ol>
<li><p>the &#8220;thing&#8221; i do in school, still making very slow progress, some of the guys starting contribute to the group, i am glad to see that.</p></li>
<li><p>i made a small web app called find-the-one for guokr group&#8217;s searching. it works fine, i learn some new technic and it might be helpful in the future.</p>

<ul>
<li>the very first redone of i made that is because I was trying to find if there&#8217;s any girl i might found interesting in tianjin. so i wrote that app, it seems that my hope <strong>didn&#8217;t come true.</strong></li>
<li>but, there is quite amount of people like that app and using it. so, i am glad i can make another stuff people like.</li>
<li>that app is in the Guokr.com&#8217;s homepage :) it got about 1000pv in it&#8217;s first day.</li>
</ul>
</li>
</ol>


<h1>Some other stuff</h1>

<p>  basically, i write this just want to say， i am trying so hard to moving on, and i think somehow, it might work :)</p>

<p>  And there&#8217;s another interesting story, there&#8217;s a front desk girl i ‘kinda’ like from the company that gave me the very first job offer but i didn&#8217;t accept in the end. she saw my WeiBo about IronMan3, and we talk about the comment &#8216;haha hahaha hahahaha&#8217; i gave to that movie, i went great and i found her interesting too, and she like&#8217;s billiard too. so, I might have chance to see her again, but not interview involved this time! good luck.</p>

<p>  One last thing, i am gonna to re-watch the An <a href="http://movie.douban.com/subject/1866479/" title="The Avengers">The Avengers</a> again, since i just finished the IronMan 3 a few days ago.</p>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-04-21T00:02:00+08:00" pubdate data-updated="true">Apr 21<span>st</span>, 2013</time></div>
		<div class="tags">

</div>
		
			<span class="comments"><a href="/blog/2013/04/21/i-dont-like-this-busy-week/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2013/04/21/i-dont-like-this-busy-week/">I Don&#8217;t Like This Busy Week, but I Made It Through. So Far</a></h1>
	<div class="entry-content">
		<p>hi, it&#8217;s been a while:) i just had some busy weeks and finally, i think i can take a break now. i can spend more time with friends and my personal work, plus some go on dates, if i am <strong>luckily</strong> enough.</p>

<p>i had been playing multiply roles for some weeks.</p>

<h3>System Administrator</h3>

<ul>
<li>Since the data on our servers got destroyed by mistake, i have to do that form scratch and got some new problems, mostly because we now work at a new lab with different networking enviroment.  it took some extra work. and also i have to re-write and setup our team wiki pages. i think that wiki is important but some of the guys in the team didn&#8217;t think that way, fine. now i can say that with confident that i am fully qualified for a <strong>SA</strong> position:)</li>
</ul>


<h3>HR guy</h3>

<ul>
<li>All right, it&#8217;s not that <strong>official</strong>, but i do have some rights at this team right now, and i did have received some resumes and <strong>hire</strong> someone to do stuffs with us, LOL. hoping i hired the right guy. and i am still want people to work with us, see the recruiting ad here:

<ol>
<li><a href="http://www.sunus.me/downloads/os-recuriting.pdf" title="download os-recuriting.pdf">PDF version: http://www.sunus.me/downloads/os-recuriting.pdf</a></li>
<li><a href="http://www.readability.com/articles/6feglmeo">HTML version: http://www.readability.com/articles/6feglmeo</a></li>
</ol>
</li>
<li>i am waiting, join us soon:)</li>
</ul>


<h3><em>Talker</em></h3>

<ul>
<li>I don&#8217;t know what the fuck the <em>talker</em> is ? but i can explain what that is, i talked with some of the main members our this team, asked their thougths on this <strong>thing</strong> we are doing right now, what&#8217;re they thinking and what they want to do next. and their answer is just, let&#8217;s say, simple.</li>
<li>I used to have pretty high admire on them, and i used to think i can count on them. but right now, i think i have to re-consider those thoughts. obviously they have other pressing matters right now, i have no comment on this and i have no right to judge them. but, i have mine too, and it&#8217;s the main reason why i came back this year. it&#8217;s definitely <strong>NOT</strong> what we do right now. if you don&#8217;t have motivation or this s not interested to you any more, you can quit. because at this point, i just find out every one right now are replaceable, i can not see the quality/ability we need in you right now, but, i once think you have those.</li>
</ul>


<h3>Secretary</h3>

<ul>
<li>Yes, secretary. I wrote a lot those days and i knew what i know my writing skills sucks. glad i have some guy to help me. final, i finished those crap, I can not believe some parts of those paper are written by me.</li>
<li>besides writing papers, I went around, hand in papers to different people, get their signature. even printed the paper.</li>
<li>A teacher call me everyday around 9 am to wake up and go to he office, to write.</li>
</ul>


<h3>Team Leader</h3>

<ul>
<li>i don&#8217;t like this title, but i did have those title in some document files. since i talked to the guys in the team, i have to think and assigned tasks about we need to do at this point and future as well to them, based on their skills, attitute and motivation. i think i am doing ok, hoping they will do the same:)</li>
</ul>


<h3>Developer</h3>

<ul>
<li>yeah, that&#8217;s what i love most, luckily i found i need some simple but basic feature/service but it didn&#8217;t exist. so i write a script to get it done and i am using it on a daily basis. of course i open source of this project at <strong><a href="https://github.com/sunuslee/bub">github The Backup-Box</a></strong></li>
<li><a href="https://github.com/sunuslee/bub">The Backup-Box </a> it can sync/backup you files using the services provided by stuffs like dropbox, google drive, amazon cloud but offers a feature that allowed you to select any files on your machine and get it backed up, <strong>you don&#8217;t have to manually put those files into the directory in the cloud drive</strong></li>
<li>yesterday i found the first version code of hub looks ugly and seems confuse, so i rewrite most of them, it now looks much like my code:)</li>
<li>i start to take license seriously, so i chose <em>MIT Open Source License</em> to publish bub.</li>
</ul>


<h3>Student</h3>

<ul>
<li>i went to a Linux class in school, but i ran off in less than ten minutes.because i don&#8217;t find any nice girl in the classroom.</li>
<li>kidding, i got other stuff to take care of at that time.</li>
<li>kidding, again. if there is nice girl in the classroom, that &#8216;other stuff&#8217; can certainly wait another hour:)</li>
</ul>


<h2>Some other stuffs</h2>

<ul>
<li>i am glad i still stay in the campus and did&#8217;t want to <strong>quit</strong> again. this is a quit week and i don&#8217;t really enjoy this kind of busy, it&#8217;s not what i want. i just want to do <strong>my thing</strong> and get it done perfectly.</li>
<li>i don&#8217;t even got time to swim, but i got time to swim and writing blog today, it feels great. i am making progress in the pool.</li>
<li>i watched a great movie called <a href="http://movie.douban.com/subject/1308741/"><em>waiting alone</em> (<strong>http://movie.douban.com/subject/1308741/</strong>)</a> , i found it just like a mirror to me and i just found my <strong>Liu Rong</strong> in my life, or maybe i knew it for quite a while but afraid to admit it? god, i wish i can watch this movie earlier.</li>
<li>i will watch another great movie <em>Django Unchained</em> this week. i should watch it earlier but just too busy this week, now that i got time, i will watch it.</li>
</ul>


<h2>Something is missing ?</h2>

<p>nope:)
good night and wish me luck.</p>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-03-31T22:13:00+08:00" pubdate data-updated="true">Mar 31<span>st</span>, 2013</time></div>
		<div class="tags">

</div>
		
			<span class="comments"><a href="/blog/2013/03/31/ying-yao/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2013/03/31/ying-yao/">应邀发个以前C语言的小quiz</a></h1>
	<div class="entry-content">
		<h3>原标题</h3>

<h2>装逼遭雷劈。这个2b bug 把我的周末毁了。</h2>

<figure class='code'><figcaption><span> (zb.c)</span> <a href='/downloads/code/zb.c'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt;</span>
</span><span class='line'><span class="cp">#define fo2_bug(ins, outs) _fo2_bug(ins, outs, strlen(ins))</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">_fo2_bug</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">ins</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">outs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="p">(</span><span class="o">!</span><span class="n">ungetc</span><span class="p">(</span><span class="o">*</span><span class="n">ins</span><span class="p">,</span> <span class="n">stdin</span><span class="p">)</span> <span class="o">?</span> <span class="o">:</span> <span class="n">_fo2_bug</span><span class="p">(</span><span class="n">ins</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">outs</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">outs</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">());</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
</span><span class='line'>        <span class="kt">char</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="s">&quot;2b sunus&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="n">fo2_bug</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
</span><span class='line'>        <span class="n">buf</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">a</span><span class="p">)]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>因为ungetc的原因，代码请用gcc编译vc/vs对ungetc的处理不很好。</p>

<p>fo2_bug就是2b的字符串反转函数,把字符串ins反转之后存到outs.在main调用fo2_bug之后。会有点异想不到的事情花生～～</p>

<p>有同学说说fo2_bug这个函数的bug在哪儿，bug的症状是啥，为什么会出现bug&#8230;怎么fix就随便吧，太轻松了～</p>

<p>答对的女同学我请吃饭吧..</p>

<p>男同学，嗯。。送一个月高速PROXY或者迅雷会员吧&#8230;.<sup>^</sup></p>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-03-25T22:17:00+08:00" pubdate data-updated="true">Mar 25<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/life/'>life</a>


</div>
		
			<span class="comments"><a href="/blog/2013/03/25/0x17/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2013/03/25/0x17/">0x17</a></h1>
	<div class="entry-content">
		<p>hi, there.
yeah, i am gonna turn 0x17 tomorrow, that&#8217;s another whole new year for me and i think i just end my time in 0x16.
after reading my last year&#8217;s post, the theme of my 0x16 is &#8216;trying hard to be a guy that deserves you&#8217; , i think i failed, but i will continue to do so in my upcoming 0x17 times :)</p>

<p><strong>I failed to win her heart :&lt;</strong></p>

<p>but anyway, my 0x16 times turned out to be good. i got a nice job in the early year, i learned a lot from those awesome guys i met in the dev team and i gained a lot, i wish to be as good as them in the beginning. but in the end, i got acknowledged by them. it&#8217;s not easy, but it&#8217;s quite a lot of fun.</p>

<p><strong>I really enjoyed thoses times in beijing, writing codes and getting paid and having tons of fun with new friends</strong></p>

<p>then, i quit that job and got back to school, plan to having some normal college student&#8217;s life. that&#8217;s, mostly a serious relationship with someone i like.</p>

<p><strong>I need some motivation to be excellent againn</strong></p>

<p>Also, this year, the main reason of me quitting the job and getting back to schol is, i really really want some <em>changes</em>, though i don&#8217;t know what that is, but it will come eventually, right?</p>

<p><strong>I already made some of those, namely from user-friendly linux distribution to a more flexible one, from linux to OS X, from vim to emacs, etc</strong></p>

<p>I think this year will be awesome, and i&#8217;d love to take all the challenges and opportunity in the upcoming days.</p>

<p><strong>i will do more sports!</strong></p>

<p><strong>happy birthday and good luck for whatever that is.</strong></p>

<p>END OF 0x16.</p>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-03-17T10:48:00+08:00" pubdate data-updated="true">Mar 17<span>th</span>, 2013</time></div>
		<div class="tags">

</div>
		
			<span class="comments"><a href="/blog/2013/03/17/setting-up-a-lan-with-multiple-gateway-slash-interface-with-iptables-and-route-policy-under-awesome-linux-2-slash-2/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2013/03/17/setting-up-a-lan-with-multiple-gateway-slash-interface-with-iptables-and-route-policy-under-awesome-linux-2-slash-2/">Setting Up a LAN With Multiple Gateway/interface With Iptables and Route Policy Under Awesome Linux[2/2]</a></h1>
	<div class="entry-content">
		<p><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">Setting Up a LAN With Multiple Gateway/interface With Iptables and Route Policy Under Awesome Linux</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://www.sunus.me/blog/2013/03/17/setting-up-a-lan-with-multiple-gateway-slash-interface-with-iptables-and-route-policy-under-awesome-linux-2-slash-2/" property="cc:attributionName" rel="cc:attributionURL">sunus Lee</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License</a>.</p>

<h1>The Script of ArchLinux in solution Two</h1>

<figure class='code'><figcaption><span> (setArch.sh)</span> <a href='/downloads/code/setArch.sh'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="sb">`</span>whoami<span class="sb">`</span> !<span class="o">=</span> <span class="s1">&#39;root&#39;</span> <span class="o">]</span>
</span><span class='line'><span class="k">then</span>
</span><span class='line'><span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;need root!&quot;</span>
</span><span class='line'>    <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Change this to your interface name, could it be eth* or p*p*.</span>
</span><span class='line'><span class="nv">IFACE</span><span class="o">=</span><span class="s2">&quot;wlp4s0&quot;</span>
</span><span class='line'><span class="c"># Change this to your route addr.</span>
</span><span class='line'><span class="nv">ROUTE</span><span class="o">=</span><span class="s2">&quot;192.168.1.1&quot;</span>
</span><span class='line'><span class="c"># Change this to your vpn **Server addr**</span>
</span><span class='line'><span class="nv">VPNHOST</span><span class="o">=</span><span class="s2">&quot;221.239.126.9&quot;</span>
</span><span class='line'><span class="nv">VPNADDR</span><span class="o">=</span><span class="sb">`</span>ifconfig ppp0|grep -P -o <span class="s1">&#39;(?&lt;=inet )[0-9.]*&#39;</span><span class="sb">`</span>
</span><span class='line'><span class="nv">VPNROUTE</span><span class="o">=</span><span class="sb">`</span>ifconfig ppp0|grep -P -o <span class="s1">&#39;(?&lt;=destination )[0-9.]*&#39;</span><span class="sb">`</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;VPN-ADDR:&quot;</span><span class="nv">$VPNADDR</span>
</span><span class='line'><span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;ip route add $VPNHOST via $ROUTE dev $IFACE&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="nv">$cmd</span>
</span><span class='line'><span class="nv">$cmd</span>
</span><span class='line'><span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;route add default gw $VPNROUTE&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="nv">$cmd</span>
</span><span class='line'><span class="nv">$cmd</span>
</span><span class='line'><span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;route del default gw $ROUTE&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="nv">$cmd</span>
</span><span class='line'><span class="nv">$cmd</span>
</span><span class='line'><span class="c"># The net is the route&#39;s subnet. be careful.</span>
</span><span class='line'>route add -net 192.168.1.0/24 gw 192.168.1.1
</span><span class='line'><span class="nb">echo</span> -e <span class="s1">&#39;nameserver 8.8.8.8\nsearch 8.8.4.4&#39;</span> &gt; /etc/resolv.conf
</span></code></pre></td></tr></table></div></figure>


<h1>The Script of Route in final solution</h1>

<ul>
<li>see the <strong>Working iptables rules</strong> at here:

<ul>
<li><a href="https://gist.github.com/sunuslee/5179422">https://gist.github.com/sunuslee/5179422</a></li>
<li>you probobly need to modify this file a little bit, or just create your own with <code>iptables-save &gt; filename</code></li>
<li>make sure you have <strong>PPP0-IP</strong> in that file. because this script will replace <strong>PPP0-IP</strong> with the real <strong>PPP0-IP</strong> address.</li>
<li>you need to put the file working-iptables-rules along with setroute.sh, in the same directory.</li>
<li>if you are interested, those lines contain |sunus-a/b/c/d| are the Log, demonstration of how the packets went through all the way from one end to another.</li>
<li>this may have <strong>bugs</strong>, most likely.</li>
</ul>
</li>
</ul>


<figure class='code'><figcaption><span>Setting the route (setroute.sh)</span> <a href='/downloads/code/setroute.sh'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nv">SUNUS_IP</span><span class="o">=</span><span class="s1">&#39;192.168.1.169&#39;</span>
</span><span class='line'><span class="nv">VPN_ROUTE</span><span class="o">=</span><span class="sb">`</span>ifconfig ppp0|grep -o <span class="s1">&#39;P-t-P:[0-9.]*&#39;</span>|tr -d <span class="s1">&#39;P-t-P:&#39;</span><span class="sb">`</span>
</span><span class='line'><span class="nv">VPN_IP</span><span class="o">=</span><span class="sb">`</span>ifconfig ppp0|grep -o <span class="s1">&#39;addr:[0-9.]*&#39;</span>|tr -d <span class="s1">&#39;addr:&#39;</span><span class="sb">`</span>
</span><span class='line'><span class="nv">TMP_RULES_FILE</span><span class="o">=</span><span class="s1">&#39;/tmp/TRF&#39;</span>
</span><span class='line'><span class="nv">ROUTE_TABLE</span><span class="o">=</span><span class="s1">&#39;sunusroute&#39;</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$VPN_ROUTE&quot;</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> -o <span class="s2">&quot;$VPN_IP&quot;</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]</span>
</span><span class='line'><span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nb">echo</span> -e <span class="s2">&quot;\n*********\n&quot;</span>
</span><span class='line'>  <span class="nb">echo</span> <span class="s2">&quot;No VPN-Connection&quot;</span>
</span><span class='line'>  <span class="nb">echo</span> <span class="s2">&quot;Make sure your xl2tp is working&quot;</span>
</span><span class='line'>  <span class="nb">echo</span> -e <span class="s2">&quot;\n*********\n&quot;</span>
</span><span class='line'>  <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'>sed <span class="s2">&quot;s/PPP0-IP/$VPN_IP/&quot;</span> working-iptables-rule &gt; <span class="nv">$TMP_RULES_FILE</span>
</span><span class='line'><span class="nb">echo</span> -e <span class="s2">&quot;\n*********\n&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;VPN-ROUTE:&quot;</span><span class="nv">$VPN_ROUTE</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;VPN-ADDR:&quot;</span><span class="nv">$VPN_IP</span>
</span><span class='line'>
</span><span class='line'>ip route add default via <span class="nv">$VPN_ROUTE</span> dev ppp0 table <span class="nv">$ROUTE_TABLE</span>
</span><span class='line'>ip rule add from <span class="nv">$SUNUS_IP</span> table <span class="nv">$ROUTE_TABLE</span>
</span><span class='line'>ip route flush cache
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;setting ip rules and route-policy successfully&quot;</span>
</span><span class='line'><span class="nb">echo</span> -e <span class="s2">&quot;\n*********\n&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> -e <span class="s2">&quot;\n*********\n&quot;</span>
</span><span class='line'>iptables-restore &lt; <span class="nv">$TMP_RULES_FILE</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;setting iptables successfully&quot;</span>
</span><span class='line'><span class="nb">echo</span> -e <span class="s2">&quot;\n*********\n&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> -e <span class="s2">&quot;\n*********\n&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;NOW SUNUS CAN USING THE VPN CONNECTING!&quot;</span>
</span><span class='line'><span class="nb">echo</span> -e <span class="s2">&quot;\n*********\n&quot;</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-03-16T22:09:00+08:00" pubdate data-updated="true">Mar 16<span>th</span>, 2013</time></div>
		<div class="tags">

</div>
		
			<span class="comments"><a href="/blog/2013/03/16/setting-up-a-lan-with-multiple-gateway-slash-interface-with-iptables-and-route-policy/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2013/03/16/setting-up-a-lan-with-multiple-gateway-slash-interface-with-iptables-and-route-policy/">Setting Up a LAN With Multiple Gateway/interface With Iptables and Route Policy Under Awesome Linux[1/2]</a></h1>
	<div class="entry-content">
		<p><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">Setting Up a LAN With Multiple Gateway/interface With Iptables and Route Policy Under Awesome Linux</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://www.sunus.me/blog/2013/03/16/setting-up-a-lan-with-multiple-gateway-slash-interface-with-iptables-and-route-policy/" property="cc:attributionName" rel="cc:attributionURL">sunus Lee</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License</a>.</p>

<h1>Introduction</h1>

<p>First of all, it all because my MacBookPro&#8217;s xl2tp utils can not work under my school&#8217;s networking enviroment. so this is how the post is born.</p>

<p>I have been digging with those stuffs for almost a week, and now, finally i get it rolling and it seems awesome. this post will talks about netfilter known as iptables and ip route policy. and some technic/tool like tcpdump will be involved as well.</p>

<h1>Environment</h1>

<p>The environment i have is like this below:</p>

<pre><code>-----------------    -----------------
| Slow          |    | Fast          |
| Internet-1    |    | Internet-2    |
| 10.10.149.1   |    | 123.150.232.1 |
-----------------    -----------------
         |             |
[eth0.2] |             |[ppp0]
         |             |
        --------------------------
        | Route, Running Linux   |
        | br-lan: 192.168.1.1    | [br-lan]      ------------------------
        | ppp0:   123.150.232.74 | --------------| Other Machines in Lan|
        | eth0.2: 10.10.149.4    |               ------------------------
        --------------------------
        |                        |
[br-lan]|                        |[br-lan]
        |                        |
        |                        |
        |                        |
  -------------------------      ----------------------
  |ArchLinux              |      | MacBook            |
  |eth0: 192.168.1.245    |      | en0:192.168.1.169  |
  |ppp0: 180.134.135.173  |      |                    |
  -------------------------      ----------------------
        |
        |
        |
        |
  ------------------
  | Fast           |
  | Internet-3     |
  | 180.134.135.1  |
  ------------------
</code></pre>

<p>   after connect the wires. there is three <strong> physic wires </strong>:</p>

<ul>
<li><strong>Route</strong> <------> <strong>Slow Internet-1 </strong>this is the only one that connects to outside my dorm. via route&#8217;s port WAN.</li>
<li><strong>Route</strong> <------> <strong> ArchLinux </strong> this one is in a Route&#8217;s port #1 LAN</li>
<li><strong>Route</strong> <------> <strong> MacBook </strong> same as above, using Route&#8217;s port #2 LAN</li>
</ul>


<p>  There is also something to be noticed:</p>

<ul>
<li><p>the <strong>ppp0</strong> in <strong>Route</strong> is a high-speed connection(VPN). it needs to go though <strong>eth0.2</strong> to connect the VPN-server, then it will generate a Virtual Network InterFace, that is, ppp0.</p></li>
<li><p>the another <strong>ppp0</strong> in <strong>ArchLinux</strong> is also the high-speed connection. but firstly, it goes to <strong>Route</strong>, then the VPN-server.</p></li>
<li><p>in this environment, you can consider those ppp0 as real NICs that are connected to the internet as well.</p></li>
<li><p>So, we can say eth0.2 and two ppp0 are all outgoing Interfaces.</p></li>
</ul>


<h1>Solutions</h1>

<ul>
<li><p>   I repeat what i want to accomplished here:</p>

<p>   1 .    i want my MacBook can connected to the internet.</p>

<p>   2 .    i want my MacBook&#8217;s internet connection to be as <strong>FAST</strong> as possible.</p></li>
<li><p>   Before we get started, there&#8217;s something we can do and can&#8217;t do, in general.</p>

<p>   1 .    Seting the <strong>default route</strong> to 180.134.135.1 for ArchLinux and a route to lan. We do this because we want all the trafftic goes to a fast internet connecting while we keep the connection to the other machines in the lan still work.</p>

<pre><code># route add -net 192.168.1.0/24 gw 192.168.1.1 dev eth0
# route add default gw 180.134.135.1 dev ppp0
</code></pre>

<p>   2 .    Because there is other machines in the lan, so we can not set 123.150.232.1 as <strong>default route</strong> for Route, just like the ArchLinux. there is only <strong> me </strong> can access the Fast Internet-2.( The <strong>Benefit</strong> of being me or with me :) lol! )</p></li>
</ul>


<h2>The Slow Solution</h2>

<ul>
<li><p>   Making the MacBook can connect to the internet, but it just too slow for me. Just set up machines and route like the diagram above, it will result this:</p>

<p>   1 .  the ArchLinux using Internet-3.</p>

<p>   2 .  the MacBookPro using Slow-Internet-1</p></li>
</ul>


<h2>The A Little Bit Faster Solution</h2>

<ul>
<li><p>   Making the MacBook Using ArchLinux&#8217;s Internet-3 and the ArchLinux still keep unchanged in Slow Solution. This solution requires those steps.</p>

<ul>
<li><p>  in the MacBook, change default route from 192.168.1.1 to 192.168.1.245</p>

<p> In MacBook:
 # route add default 192.168.1.245
 # route del default 192.168.1.1</p></li>
<li><p>  in ArchLinux, set up a route policy/rule</p>

<ul>
<li><p>  the packets that comes from MacBook(192.168.1.169), Using the gateway of Internet-3.</p>

<pre><code>In ArchLinux:
# add a empty table to route table
echo '7375 SunusRules' &gt;&gt; /etc/iproute2/rt_tables
# add a default route rule to newly create table SunusRules
ip route add default via 180.134.135.173 dev ppp0 table SunusRules
# add this table to routing rules, all the packet comes from MacBook, apply this route rule.
ip rule add from 192.168.1.169 table SunusRules
</code></pre></li>
<li><p> We are done here.</p></li>
<li><p> In fact, i don&#8217;t think add a route rule here is necessarily, but anyway, it&#8217;s a good time to get the first impression of what this can do. which we will make the best use of it in next Solution.</p></li>
</ul>
</li>
</ul>
</li>
</ul>


<h2>The Ultimate And More Fast Solution, so far</h2>

<ul>
<li><p>   As you may think, why we still didn&#8217;t use Fast-Internet-2 yet. Now, it&#8217;s time to rolling on this connection! Let the MacBook and only MacBook use this connection.</p>

<ul>
<li><p> In fact, this is a kinda complicated process, we need to do the following stuffs to put it all together to work properly.</p>

<p> 1 . Leave MacBook&#8217;s default (192.168.1.1) untouched.</p>

<p> 2 . Let the Route know, if a packet is come from MacBook(192.168.1.169), sets the <strong>Gateway</strong> of this connection to 1123.150.232.1 and <strong>Outgoing Interface</strong> to ppp0. because at this point, only ppp0 can connect to it&#8217;s <strong>Gateway</strong>(123.150.232.1)</p>

<ul>
<li>  <strong>policy routing</strong> is the first magic.

<ul>
<li>as most of us might already knew that, the linux kernel only allow exactly one <strong>efficient default</strong> in <strong>route table</strong>.</li>
<li>so this needs is beyond a simple <code>route</code> command can do. but, don&#8217;t worry. net-tools is out of date for so long, let us introduce the new <code>ip</code> tools to do this for us.</li>
<li>basically, this is still maintain that one kernel default route in route table, but, it allow us to add custom route table based on our needs, and set up the right condition. e.g <strong>the packet&#8217;s source address/net</strong> or <strong>the incoming interface</strong>, etc see <code>ip route help</code>.

<ul>
<li><p>the steps to make this happened are:</p>

<pre><code># add a table id and table name to the route table database, just make sure they are unique.
echo '7375 sunusroute' &gt;&gt; /etc/iproute2/rt_tables
# check if that succeeded, the out should be empty.
ip route show table sunusroute
# then, add route rules to this newly create table.
# set the default route/gateway of this table
ip route add default via 123.150.232.1 dev ppp0
# finally, add a rule to tell the kernel, under what circumstance,
the packet should use the route table from what we just set,
instead of the default route rules. we just set this simple rule, if a packet is from 192.168.1.169, then apply the rules in route table sunusroute.
ip rule add from 192.168.1.169 table sunusroute
</code></pre></li>
<li><p>check if those are valid by:</p>

<pre><code>ip rule show
&gt;&gt; 0: from all lookup local
&gt;&gt; 32761: from 192.168.1.169 lookup sunusroute
&gt;&gt; many-more-lines-of-other-rules
ip route show table sunusroute
&gt;&gt; default via 123.150.108.1 dev ppp0
ip route flush cache
</code></pre></li>
<li><p>the last command <code>ip route flush cache</code> is just a precaution, in case the old rules in cache might do something nasty.</p></li>
<li><p>we are done in this step.</p></li>
</ul>
</li>
</ul>
</li>
</ul>


<p> 3 . Also, Since the Route&#8217;s default gateway isn&#8217;t 123.150.232.1, so it&#8217;s a must to set packet&#8217;s <strong>source address</strong> to 123.150.232.74. so here we will do a <strong>SNAT</strong> magic.</p>

<ul>
<li><p>we are officially meet the iptables here, the firewall of the linux, a great tool for many other usages as well.</p>

<ul>
<li>the iptables consists by some tables, and those tables has some chains. the packet need to go all the way from the very first chain to the very last one. so that this packet can be send/receive correctly. during the packet&#8217;s travel in those tables and chains, it might be modify, accept, drop or reject, we can even add marks to those packets so that we can debug them.</li>
<li>here is a brief image of how a packets goes.</li>
</ul>


<p><img src="/images/iptables_traverse.jpg" title="iptables_traverse" alt="iptables packetes traversal path" /></p>

<ul>
<li>obviously, what we want the route to do is:</li>
</ul>


<p><strong>forward the packets from 192.168.1.169 to interface ppp0 with the right gateway 123.150.231.1</strong></p>

<ul>
<li><p>follow the diagram, the packets should go through the tables and chains in the order of</p>

<ol>
<li>[packet come in from ppp0]</li>
<li>[raw-PREROUTING]</li>
<li>[mangle-PREROUTING]</li>
<li>[filter-PREROUTING]</li>
<li>[ROUTING-DESICION]</li>
<li>[mangle-FORWARD]</li>
<li>[filter-FORWARD]</li>
<li>[ROUTING-DESICION]</li>
<li>[mangle-POSTROUTING]</li>
<li>[nat-POSTROUTING]</li>
<li>[packet come out from ppp0]</li>
</ol>
</li>
<li><p>I once not sure/doubt about what those <strong>ROUTING-DESICION</strong> do, after my research, i think it&#8217;s just decide what <strong>route</strong> to use, basically, it just look up the routing table and get a <strong>route</strong> to use.</p></li>
<li><p>so, what we need to do is, change the packets&#8217;s source address right after the packet go off. that is, in the step ten.</p>

<p> <code>iptables -t nat -o ppp0 -j SNAT --to-address 123.150.232.74</code></p></li>
</ul>
</li>
</ul>


<p> 4 . We&#8217;re pretty much done here:)</p>

<p> 5 . Enjoy!</p></li>
</ul>
</li>
</ul>


<h1>More useful resources.</h1>

<h2>i read a lot of them to make this work, i think you should do that, too. if you <strong>relly</strong> want to fully utilize your network.</h2>

<ol>
<li><p>the <strong>iptable-tutorial</strong></p>

<ul>
<li><a href="http://www.frozentux.net/documents/iptables-tutorial">http://www.frozentux.net/documents/iptables-tutorial/</a>

<ul>
<li>pretty much every chapter is worthy reading :)</li>
</ul>
</li>
</ul>
</li>
<li><p>the awesome and notable <strong>Linux Advanced Routing &amp; Traffic Control</strong>, aka &#8216;lartc&#8217;</p>

<ul>
<li><a href="http://lartc.org">http://lartc.org</a>

<ul>
<li>especially chapter 4 and 11 are much involved in this post.</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>much more</strong> you will find in those two above.</p></li>
<li><p>1,2 also have Chinese version, thank for those guy who do the translation work!</p></li>
</ol>


<h1>PS</h1>

<h2>since i now got kinda <em>experience</em> of doing those stuffs, you are welcome to leave a message or just email me about what you think or what you want to do. i will try to help you if i can.</h2>

<h2>ANY questions and discussion are welcomed, too.</h2>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-02-24T23:58:00+08:00" pubdate data-updated="true">Feb 24<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/life/'>life</a>


</div>
		
			<span class="comments"><a href="/blog/2013/02/24/that-could-be-interesting-i-guess/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title"><a href="/blog/2013/02/24/that-could-be-interesting-i-guess/">That Could Be Interesting! I Guess.</a></h1>
	<div class="entry-content">
		<p><strong> Long time no see </strong></p>

<ul>
<li><p>Hi, there! First of all, happy new year to you and wish you all have a wonderful new year, i give you my very best wishes here:)
Yeah, i did quit my job last year and had theses about 40 days of <strong>AWESOME</strong> holidays in my hometown with my family and friends which is fun and happy. We went to couple of places with views, of course, i took some photos, too. But most of those photos are mountains and some kind of <strong>vulgar</strong> pictures. LOL</p></li>
<li><p>Besides of having fun, i got my MacBook, it&#8217;s a whole new user experiences, which i can not tell it&#8217;s better that Linux or not. but compare to Windows. it&#8217;s definitely a piece of work. Windows sucks, i said it to all the people i care about! :) I am getting used to OS X and i think it&#8217;s more comfortable to develop some <strong>app</strong> on that machine than my old laptop. But it&#8217;s okay, i do Linux-related/python work on my old machine while i am also a newcomer of APP developing. i am getting my motivations back, it just feel much better that i want to and CAN code again!</p></li>
<li><p>Tomorrow i will fly back to school and i don&#8217;t know what that is, i am leading some students to launch a <strong>OpenStack</strong> project in school, even though i don&#8217;t think that will be too much difficult for me, given the current situation we have. but still, i will do the most major work. don&#8217;t know it&#8217;s good for me or not, just wait and see how it goes. Also, i want some nice <strong>girls</strong> who&#8217;s interested in front-end to help me, i don&#8217;t know if she exists in my school.</p></li>
<li><p>Finally, the same-old-boring topic, i can not stop thinking about her, i know she also had a great great time on holiday, she sure did! so, let&#8217;s just hope she is still available. I even pray for that in a old temple. kidding! i didn&#8217;t do that:) so, still, chances are slim but i still don&#8217;t want to give up on this girl who had stolen my heart for months, in some point stolen my codes as well:&lt; hoping i can make this right. We didn&#8217;t send a word to each other in this whole holiday and i am not sure if she still remember me or not. but, i had hard time picking gifts for her and lucky(or not?) enough, i got something gift picking advice from my friends and sisters. so, just wait and see if she like that or not.</p></li>
<li><p>I am Back and I miss you all! the new semester could be a interesting one, not because of the school or class but you and all the uncertain changes and opportunity i wanted for a while!!</p></li>
</ul>


		
		
	</div>

</article>

<nav id="pagenavi">
    
    
        <a href="/blog/page/2/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav>
</div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2013

    sunus


Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
			<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'sunusblog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





		</div>
	</div>
    <!-- Start of StatCounter Code for Default Guide -->
    <script type="text/javascript">
        var sc_project=7653790; 
        var sc_invisible=1; 
        var sc_security="bd47e345"; 
    </script>
    <script type="text/javascript"
        src="http://www.statcounter.com/counter/counter.js"></script>
    <noscript><div class="statcounter"><a title="web counter"
                href="http://statcounter.com/free-hit-counter/"
                target="_blank"><img class="statcounter"
                src="http://c.statcounter.com/7653790/0/bd47e345/1/"
                alt="web counter"></a></div></noscript>
    <!-- End of StatCounter Code for Default Guide -->
</body>
</html>
